<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuickChat - Projet Ultime</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:Arial, sans-serif; }
    body { background:#f9f9f9; padding:15px; max-width:700px; margin:15px auto; }
    .header { 
      text-align:center; margin-bottom:15px; padding:12px; 
      background:linear-gradient(135deg, #6e8efb, #a777e3); 
      color:white; border-radius:10px; display:flex; justify-content:space-between; align-items:center; 
    }
    .header h2 { margin:0; display:flex; align-items:center; gap:8px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
    .login-screen, .chat-app { background:white; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    .chat-app { display:none; }
    .input-area { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    input, button { padding:10px; border-radius:8px; border:1px solid #ddd; font-size:14px; }
    #pseudo, #msg { flex:1; min-width:150px; }
    button { background:#6e8efb; color:white; border:none; cursor:pointer; font-weight:bold; }
    button:hover { opacity:0.9; }
    #recordBtn.active { background:#e74c3c; }
    #chat { 
      height:350px; border:1px solid #eee; margin:10px 0; padding:12px; 
      overflow-y:auto; background:#fff; border-radius:8px; position: relative;
    }
    .message { 
      margin:10px 0; padding:10px; background:#f5f5f5; border-radius:10px; 
      word-wrap:break-word; position:relative; 
    }
    .sender { font-weight:bold; }
    .edited { font-size:0.9em; color:#666; }
    .media, .audio-player { margin-top:8px; max-width:250px; border-radius:8px; }
    .actions { margin-top:8px; font-size:0.9em; color:#555; }
    .actions button { padding:4px 8px; margin-right:5px; font-size:0.9em; }
    .clear-btns { margin-top:10px; text-align:center; }
    .clear-btns button { padding:8px 12px; margin:0 5px; }

    /* üî∏ Menu de suppression */
    .message-actions-menu {
      position: absolute;
      right: 10px;
      top: 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
    .message-actions-menu button {
      display: block;
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
      color: #333;
    }
    .message-actions-menu button:hover {
      background: #f0f0f0;
    }
    .message .dots {
      position: absolute;
      right: 8px;
      top: 8px;
      cursor: pointer;
      color: #999;
      font-size: 20px;
      display: none;
    }
    .message:hover .dots {
      display: block;
    }
  </style>
  <audio id="notif-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" preload="auto"></audio>
</head>
<body>
  <div class="header">
    <h2>üí¨ QuickChat ULTIME</h2>
    <div class="clear-btns" id="clearButtons" style="display:none;">
      <button onclick="clearMine()">üóëÔ∏è Effacer mes messages</button>
    </div>
  </div>
  
  <div class="login-screen" id="login">
    <h3>üë§ Entrez un pseudo</h3>
    <input type="text" id="pseudo" placeholder="Ex: Ali, Sara..." maxlength="15" />
    <div class="controls">
      <button onclick="join()">Rejoindre le chat</button>
    </div>
  </div>

  <div class="chat-app" id="chatApp">
    <div id="chat"></div>
    
    <div class="input-area">
      <input type="text" id="msg" placeholder="Message... (tape 'remove conv from all' pour effacer tout)" />
      <button onclick="send()">Envoyer</button>
      <button id="recordBtn" onclick="toggleRecording()">üé§</button>
      <input type="file" id="fileInput" accept="image/*,video/*" onchange="sendFile()" style="display:none;">
      <button onclick="document.getElementById('fileInput').click()">üìÅ</button>
    </div>
  </div>

  <script>
    let user = '';
    let mediaRecorder;
    let audioChunks = [];
    let socket = null;

    function connectWebSocket() {
      socket = new WebSocket('wss://' + window.location.host);
      
      socket.onopen = () => {
        console.log('üü¢ Connect√© au serveur');
      };

      socket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'history') {
          document.getElementById('chat').innerHTML = '';
          data.messages.forEach(msg => displayMessage(msg));
          document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
        } 
        else if (data.type === 'message') {
          displayMessage(data.text, data.id, data.timestamp, data.media, data.audio);
          document.getElementById('notif-sound').play().catch(()=>{});
        }
        else if (data.type === 'edit') {
          const msgDiv = document.querySelector(`.message[data-id="${data.id}"]`);
          if (msgDiv) {
            const sender = extractSender(data.text);
            const color = stringToColor(sender);
            const match = data.text.match(/(\[.*?\]\s*.*?:)\s*(.*)/);
            if (match) {
              msgDiv.innerHTML = `<span class="sender" style="color:${color}">${match[1]}</span> ${match[2]} <span class="edited">(‚úèÔ∏è modifi√©)</span>`;
            }
          }
        }
        else if (data.type === 'delete_message') {
          const msgDiv = document.querySelector(`.message[data-id="${data.id}"]`);
          if (msgDiv) msgDiv.remove();
        }
        else if (data.type === 'clear_all') {
          document.getElementById('chat').innerHTML = '';
          alert('üóëÔ∏è La conversation a √©t√© effac√©e par un utilisateur.');
        }
      };

      socket.onerror = (error) => {
        console.error('‚ùå Erreur WebSocket:', error);
      };

      socket.onclose = () => {
        console.log('üî¥ Connexion ferm√©e');
        setTimeout(() => {
          if (user) connectWebSocket();
        }, 3000);
      };
    }

    function stringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      let color = '#';
      for (let i = 0; i < 3; i++) {
        const value = (hash >> (i * 8)) & 0xff;
        color += ('00' + value.toString(16)).substr(-2);
      }
      return color;
    }

    function extractSender(message) {
      const match = message.match(/^\[.*?\]\s*(.*?):/);
      return match ? match[1] : 'Inconnu';
    }

    function displayMessage(fullMessage, id, timestamp, mediaData, audioData) {
      if (!fullMessage || typeof fullMessage !== 'string') {
        console.warn('Message invalide re√ßu:', fullMessage);
        return;
      }

      const chat = document.getElementById('chat');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      if (id) messageDiv.dataset.id = id;
      if (timestamp) messageDiv.dataset.timestamp = timestamp;

      const sender = extractSender(fullMessage);
      const color = stringToColor(sender);
      const match = fullMessage.match(/(\[.*?\]\s*.*?:)\s*(.*)/);
      
      if (match) {
        messageDiv.innerHTML = `<span class="sender" style="color:${color}">${match[1]}</span> ${match[2]}`;
      } else {
        messageDiv.textContent = fullMessage;
      }

      // üî∏ M√©dias
      if (audioData) {
        const audioElement = document.createElement('audio');
        audioElement.controls = true;
        audioElement.style.width = '100%';
        audioElement.src = audioData;
        messageDiv.appendChild(document.createElement('br'));
        messageDiv.appendChild(audioElement);
      }
      if (mediaData) {
        const isVideo = mediaData.includes('video/');
        const mediaElement = isVideo 
          ? document.createElement('video') 
          : document.createElement('img');
        if (isVideo) {
          mediaElement.controls = true;
          mediaElement.style.width = '250px';
        } else {
          mediaElement.style.maxWidth = '250px';
          mediaElement.style.borderRadius = '8px';
        }
        mediaElement.src = mediaData;
        messageDiv.appendChild(document.createElement('br'));
        messageDiv.appendChild(mediaElement);
      }

      // üî∏ Actions (modifier) ‚Äî SEULEMENT pour tes messages
      if (timestamp && Date.now() - timestamp < 5 * 60 * 1000 && sender === user) {
        const actions = document.createElement('div');
        actions.className = 'actions';
        const safeMsg = fullMessage.replace(/`/g, '\\`').replace(/\$/g, '\\$');
        actions.innerHTML = `<button onclick="editMessage('${id}', \`${safeMsg}\`)">‚úèÔ∏è Modifier</button>`;
        messageDiv.appendChild(actions);
      }

      // üî∏ Menu ‚ãÆ ‚Äî SEULEMENT pour tes messages
      if (sender === user) {
        const dots = document.createElement('span');
        dots.className = 'dots';
        dots.innerHTML = '‚ãÆ';
        dots.onclick = (e) => {
          e.stopPropagation();
          showActionsMenu(messageDiv, id, fullMessage);
        };
        messageDiv.appendChild(dots);
      }

      chat.appendChild(messageDiv);
      chat.scrollTop = messageDiv.offsetTop;
    }
    function showActionsMenu(messageDiv, messageId, fullMessage) {
  // Cacher les autres menus
  document.querySelectorAll('.message-actions-menu').forEach(el => el.remove());

  const menu = document.createElement('div');
  menu.className = 'message-actions-menu';
  
  // Option 1: Supprimer pour moi
  const deleteForMe = document.createElement('button');
  deleteForMe.innerHTML = 'üóëÔ∏è Supprimer pour moi';
  deleteForMe.onclick = () => {
    messageDiv.remove();
    menu.remove();
  };
  menu.appendChild(deleteForMe);

  // Option 2: Supprimer pour tous
  const deleteForAll = document.createElement('button');
  deleteForAll.innerHTML = 'üåç Supprimer pour tous';
  deleteForAll.onclick = () => {
    if (confirm('Supprimer ce message pour TOUS les utilisateurs ?')) {
      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'delete_for_all',
          id: messageId,
          originalPrefix: fullMessage.split('] ')[0] + '] '
        }));
        messageDiv.remove();
      } else {
        alert('Connexion perdue.');
      }
    }
    menu.remove();
  };
  menu.appendChild(deleteForAll);

  // üî∏ Option 3: Fermer le menu
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '‚ùå Fermer';
  closeBtn.onclick = () => {
    menu.remove();
  };
  menu.appendChild(closeBtn);

  messageDiv.appendChild(menu);
  menu.style.display = 'block';
}
    function editMessage(id, fullMessage) {
      const content = fullMessage.split(': ').slice(1).join(': ');
      const newText = prompt('Modifier le message :', content);
      if (newText !== null && newText.trim() !== '') {
        const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        const updatedMsg = fullMessage.replace(/: .*/, `: ${newText.trim()}`);
        const prefix = fullMessage.split('] ')[0] + '] ';
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            type: 'edit',
            id: id,
            text: updatedMsg,
            originalPrefix: prefix
          }));
        }
      }
    }

    function toggleRecording() {
      const btn = document.getElementById('recordBtn');
      if (btn.classList.contains('active')) {
        if (mediaRecorder) mediaRecorder.stop();
        btn.classList.remove('active');
        btn.textContent = 'üé§';
      } else {
        startRecording();
      }
    }

    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.onload = () => {
              const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
              const msg = `[${t}] ${user}: üéß [Message vocal]`;
              // üîí Inclure le pseudo dans l'ID
              const id = `${user}-${Date.now()}-audio-${Math.random().toString(36).substr(2, 5)}`;
              if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                  type: 'message',
                  text: msg,
                  id: id,
                  timestamp: Date.now(),
                  audio: reader.result
                }));
              }
            };
            reader.readAsDataURL(audioBlob);
            document.getElementById('recordBtn').classList.remove('active');
            document.getElementById('recordBtn').textContent = 'üé§';
          };
          mediaRecorder.start();
          document.getElementById('recordBtn').classList.add('active');
          document.getElementById('recordBtn').textContent = '‚èπÔ∏è';
        })
        .catch(err => alert('Micro non autoris√© : ' + err));
    }

    function sendFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!file) return;
      if (!file.type.match('image.*|video.*')) {
        alert('Veuillez choisir une image ou une vid√©o.');
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        const mediaTag = file.type.startsWith('video') ? 'üé•' : 'üñºÔ∏è';
        const msg = `[${t}] ${user}: ${mediaTag} [M√©dia]`;
        // üîí Inclure le pseudo dans l'ID
        const id = `${user}-${Date.now()}-media-${Math.random().toString(36).substr(2, 5)}`;
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            type: 'message',
            text: msg,
            id: id,
            timestamp: Date.now(),
            media: e.target.result
          }));
        }
        fileInput.value = '';
      };
      reader.readAsDataURL(file);
    }

    function clearMine() {
      if (confirm('Effacer l‚Äôhistorique DE CE navigateur ?')) {
        document.getElementById('chat').innerHTML = '';
      }
    }

    function join() {
      const p = document.getElementById('pseudo').value.trim();
      if (p && p.length >= 2) {
        user = p;
        document.getElementById('login').style.display = 'none';
        document.getElementById('chatApp').style.display = 'block';
        document.getElementById('clearButtons').style.display = 'block';
        connectWebSocket();
      } else {
        alert('Pseudo invalide (min. 2 caract√®res).');
      }
    }

    function send() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert('Connexion perdue. Veuillez rafra√Æchir la page.');
        return;
      }

      const m = document.getElementById('msg').value.trim();
      if (m && user) {
        const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        const fullMsg = `[${t}] ${user}: ${m}`;
        // üîí Inclure le pseudo dans l'ID
        const id = `${user}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
        socket.send(JSON.stringify({ 
          type: 'message', 
          text: fullMsg,
          id: id,
          timestamp: Date.now()
        }));
        document.getElementById('msg').value = '';
      }
    }

    document.getElementById('msg').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') send();
    });
  </script>
</body>
</html>
